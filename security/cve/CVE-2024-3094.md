# CVE-2024-3094

- [CVE-2024-3094](#cve-2024-3094)
    - [취약점 주요 내용](#취약점-주요-내용)
    - [취약점 상세 설명](#취약점-상세-설명)
        - [xz/liblzma 서버가 pwn 당함](#xzliblzma-서버가-pwn-당함)
        - [OpenSSH Server](#openssh-server)
        - [systemd와 OpenSSH 서버 상호작용 및 "pwn"되는 과정](#systemd와-openssh-서버-상호작용-및-pwn되는-과정)
    - [대응 조치](#대응-조치)
    - [추가 정보 및 자원](#추가-정보-및-자원)
    - [원문](#원문)
        - [Reported Supply Chain Compromise Affecting XZ Utils Data Compression Library, CVE-2024-3094](#reported-supply-chain-compromise-affecting-xz-utils-data-compression-library-cve-2024-3094)
        - [CVE-2024-3094](#cve-2024-3094-1)
            - [Description](#description)
            - [Statement](#statement)
            - [Additional information](#additional-information)
            - [External references](#external-references)
        - [Urgent security alert for Fedora Linux 40 and Fedora Rawhide users](#urgent-security-alert-for-fedora-linux-40-and-fedora-rawhide-users)
            - [What is xz?](#what-is-xz)
            - [What is the malicious code?](#what-is-the-malicious-code)
            - [What distributions are affected by this malicious code?](#what-distributions-are-affected-by-this-malicious-code)
            - [What should I do if I am running an affected distribution?](#what-should-i-do-if-i-am-running-an-affected-distribution)

## 취약점 주요 내용

CVE-2024-3094로 지정된 이 취약점은 XZ Utils 버전 5.6.0 및 5.6.1에 악의적인 코드가 내장되어 있음을 나타낸다.
이러한 공격은 시스템에 대한 무단 접근을 허용할 수 있는 심각한 보안 위협을 제시한다.

- **영향받는 버전**: XZ Utils 5.6.0 및 5.6.1.
- **CVE 식별자**: CVE-2024-3094.
- **취약점 설명**

    이러한 버전에는 소스 코드 내의 위장된 테스트 파일에서 추출된 사전 빌드된 객체 파일을 통해 특정 liblzma 코드 함수를 수정하는 복잡한 오브스케이션(obfuscations, 난독화) 절차가 포함되어 있다.
    이로 인해 모든 소프트웨어가 이 라이브러리에 링크될 때 수정된 liblzma 라이브러리를 사용하게 되며, 이 라이브러리와의 데이터 상호작용을 가로채고 수정할 수 있다.

- **영향받는 시스템**: Fedora 41과 Fedora Rawhide 사용자들이 주요 타깃이며, 다른 배포판도 영향을 받을 수 있다.
- **권장 조치**

    개발자와 사용자들은 XZ Utils를 취약하지 않은 버전(예: 5.4.6 Stable)으로 다운그레이드하고, 악의적 활동을 탐색한 뒤 발견된 문제를 CISA에 보고하도록 권장된다.

## 취약점 상세 설명

`liblzma`는 LZMA/LZMA2 압축 알고리즘을 구현한 라이브러리로, XZ Utils에 포함되어 있다.
LZMA는 "Lempel-Ziv-Markov chain algorithm"의 약자로, 높은 압축 비율을 제공하는 것으로 알려져 있다.
`liblzma`는 이러한 압축 알고리즘을 사용하여 데이터를 압축하거나 압축 해제하는 기능을 제공한다.
주로 Linux 및 UNIX 시스템에서 파일 압축 및 아카이빙을 위해 사용된다.

취약점 설명에 따르면, 공격자는 소스 코드 내에 위장된 테스트 파일을 포함시켰다.
이 테스트 파일에서는 사전 빌드된 객체 파일이 추출되고, 이 객체 파일을 사용하여 `liblzma` 내의 특정 함수를 수정하는 복잡한 난독화(오브스케이션, obfuscations) 과정이 포함되어 있다.

이 과정은 다음과 같이 이루어진다:

1. **위장된 테스트 파일**

    이 파일은 정상적인 소스 코드처럼 보이지만, 실제로는 악의적인 목적을 가진 사전 빌드된 객체 파일을 포함하고 있다.

2. **사전 빌드된 객체 파일**

    빌드 과정 중에 이 파일이 추출되고, `liblzma` 라이브러리의 빌드 프로세스에 포함된다.

3. **함수 수정**

   추출된 객체 파일은 `liblzma` 내의 특정 함수를 수정한다.
   이 수정은 특정 조건 하에 `liblzma` 라이브러리와 상호작용하는 소프트웨어가 데이터를 처리하는 방식을 변경할 수 있다.

이러한 수정을 통해 악의적인 코드는 `liblzma` 라이브러리를 사용하는 모든 소프트웨어와의 데이터 상호작용을 가로채고 수정할 수 있게 된다.
예를 들어, 이 라이브러리를 사용하는 애플리케이션이 파일을 압축하거나 압축 해제할 때, 악의적인 코드는 이 과정을 가로채서 추가적인 악의적인 활동을 수행할 수 있다. 이는 암호화된 통신을 가로채서 복호화하거나, 시스템에 무단으로 접근하거나, 데이터를 변조하는 등 다양한 보안 위협을 야기할 수 있다.

이러한 유형의 공격은 특히 *소프트웨어의 공급망 공격*으로 분류된다.
소프트웨어 공급망 공격은 소프트웨어 개발 및 배포 과정에서 발생할 수 있는 취약점을 이용하여, 공격자가 악의적인 코드를 정상적인 소프트웨어 제품에 주입하는 것을 말한다. 이로 인해 최종 사용자는 자신도 모르는 사이에 취약한 소프트웨어를 사용하게 되며, 이는 보안 위협으로 이어질 수 있다.

### xz/liblzma 서버가 pwn 당함

xz/liblzma 서버는 `xz` 또는 `liblzma` 소프트웨어를 호스팅하고 있는 웹 서버 또는 소스 코드 저장소를 의미한다.
- `xz`는 파일 압축을 위한 프로그램
- `liblzma`는 `xz` 데이터 압축 포맷을 지원하는 라이브러리

"xz/liblzma 서버가 pwn당했다"는 해당 서버가 해킹되어 제3자에 의해 제어되고 있다는 의미다.

> `pwn`?
>
> 해킹과 관련된 커뮤니티에서 유래되었으며, 컴퓨터 시스템, 웹사이트, 서버, 또는 네트워크 등을 해킹하여 제어권을 완전히 장악하는 것을 의미한다.
> 이 단어는 원래 "own"이라는 단어의 오타에서 비롯되었지만, 시간이 지나면서 자신의 것으로 만든다는 의미의 해킹 용어로 자리 잡았다.

### OpenSSH Server

- **OpenSSH Server**

    OpenSSH(Server)는 네트워크를 통한 안전한 원격 접속을 제공하는 서비스다.
    일반적으로 서버에 설치되어 원격에서 안전한 쉘 접속(SSH 접속)을 가능하게 한다.
    로컬 머신, 즉 개인 컴퓨터에도 설치할 수 있으며, 이 경우 머신이 서버 역할을 하여 다른 시스템에서 안전하게 접속할 수 있다.

- **서버 확인**

    대부분의 리눅스 배포판에서는 `systemctl status ssh` 명령어를 통해 OpenSSH 서버의 상태를 확인할 수 있다.
    만약 서비스가 활성화되어 있다면, 시스템은 원격 접속을 위한 SSH 서버로 작동하고 있는 것이다.

- **시스템 데몬과 서버**

    OpenSSH 서버는 시스템의 데몬(백그라운드에서 실행되는 서비스 프로세스)으로 구동된다.
    즉, 서버라는 용어는 이 경우 네트워크 서비스를 제공하는 데몬을 지칭한다.

### systemd와 OpenSSH 서버 상호작용 및 "pwn"되는 과정

- **systemd**

    `systemd`는 현대 리눅스 시스템에서 사용되는 초기화 시스템 및 서비스 관리자다.
    시스템 부팅과정을 관리하고, 시스템 상의 서비스들(데몬)을 시작, 중지, 관리한다

- **상호작용 및 취약점 이용**

    공격자가 `liblzma`에 삽입된 백도어를 통해 `systemd`와 상호작용하여, 결국 OpenSSH 서버를 해킹("pwn")한다는 것은, 악의적 코드가 `systemd`를 통해 시스템 상의 다른 프로세스나 서비스에 영향을 줄 수 있다는 것을 의미한다.
    `systemd`가 다양한 시스템 레벨의 서비스를 관리하므로, 이를 통해 OpenSSH 같은 중요한 서비스에 접근하여 제어할 수 있게 된다.
    이런 방식으로 시스템의 보안이 침해되고, 공격자는 원격 코드 실행을 통해 시스템에 대한 제어권을 획득할 수 있다.

## 대응 조치

1. **즉시 사용 중단**:

    Fedora 41이나 Fedora Rawhide를 사용 중인 경우, 즉시 사용을 중단하고, xz-5.4.x로 되돌리는 절차를 따라야 한다.
    Fedora Rawhide는 Fedora Linux의 개발 배포판으로, 미래 Fedora Linux 빌드의 기반이 된다.

2. **다운그레이드 권장**

    Fedora Linux 40 사용자도 안전을 위해 5.4 빌드로 다운그레이드해야 한다.
    이미 다운그레이드를 위한 업데이트가 배포되었으며, 관련 지침을 따라 업데이트를 강제 적용할 수 있다.

3. **추가 확인**

    Red Hat Enterprise Linux(RHEL) 버전은 영향을 받지 않는다.
    Debian unstable(Sid)과 같은 다른 배포판에서도 문제의 빌드가 성공적으로 이루어진 보고가 있으므로, 다른 배포판 사용자들은 해당 배포판의 지침에 따라야 한다.

4. **악의적 코드의 영향**

    악의적인 코드는 sshd의 인증과 systemd 간의 통신을 방해하여, 잠재적으로 원격 시스템 전체에 대한 무단 접근을 가능하게 한다.

## 추가 정보 및 자원

- **CVE 세부 정보**: [CVE-2024-3094](https://www.cve.org/CVERecord?id=CVE-2024-3094)
- **안전한 버전으로의 다운그레이드 절차**: 각 배포판은 해당 문제에 대응하기 위한 고유의 절차를 제공한다. 예를 들어, Fedora 사용자는 [Fedora 업데이트 시스템](https://bodhi.fedoraproject.org/updates/FEDORA-2024-d02c7bb266)을 통해 안내를 받을 수 있다.

이 취약점은 Linux 시스템의 중요한 구성 요소에 영향을 미치므로, 가능한 한 빨리 대응 조치를 취하는 것이 중요한다. 개인 및 조직 모두 영향을 받는 버전을 사용 중인 경우, 권장되는 대응 조치를 즉시 따르는 것이 좋습니다.

## 원문

### [Reported Supply Chain Compromise Affecting XZ Utils Data Compression Library, CVE-2024-3094](https://www.cisa.gov/news-events/alerts/2024/03/29/reported-supply-chain-compromise-affecting-xz-utils-data-compression-library-cve-2024-3094)

CISA and the open source community are responding to reports of malicious code being embedded in XZ Utils versions 5.6.0 and 5.6.1. This activity was assigned CVE-2024-3094. XZ Utils is data compression software and may be present in Linux distributions. The malicious code may allow unauthorized access to affected systems.

CISA recommends developers and users to downgrade XZ Utils to an uncompromised version—such as XZ Utils 5.4.6 Stable—hunt for any malicious activity and report any positive findings to CISA.

See the following advisory for more information:

Red Hat: Urgent security alert for Fedora 41 and Rawhide users
This product is provided subject to this Notification and this Privacy & Use policy.

### [CVE-2024-3094](https://access.redhat.com/security/cve/CVE-2024-3094)

#### Description

Malicious code was discovered in the upstream tarballs of xz, starting with version 5.6.0. Through a series of complex obfuscations, the liblzma build process extracts a prebuilt object file from a disguised test file existing in the source code, which is then used to modify specific functions in the liblzma code. This results in a modified liblzma library that can be used by any software linked against this library, intercepting and modifying the data interaction with this library.

#### Statement

Current investigation indicates that the packages are only present in Fedora 41 and Fedora Rawhide within the Red Hat community ecosystem.

No versions of Red Hat Enterprise Linux (RHEL) are affected.

The malicious injection present in the xz versions 5.6.0 and 5.6.1 libraries is only included in the tarball download package. The Git distribution lacks the M4 macro that triggers the build of the malicious code. The second-stage artifacts are present in the Git repository for the injection during the build time, in case the malicious M4 macro is present. Without the merge into the build, the 2nd-stage file is innocuous. In the finder’s demonstration, it was found that it interfered with the OpenSSH daemon. While OpenSSH is not directly linked to the liblzma library, it does communicate with systemd in such a way that exposes it to the malware due to systemd linking to liblzma.

#### Additional information

- [Bugzilla 2272210](https://bugzilla.redhat.com/show_bug.cgi?id=2272210): xz: malicious code in distributed source
- [CWE-506](http://cwe.mitre.org/data/definitions/506.html): Embedded Malicious Code
- [FAQ](https://access.redhat.com/security/cve/CVE-2024-3094#cve-faq): Frequently asked questions about CVE-2024-3094

#### External references

<https://www.cve.org/CVERecord?id=CVE-2024-3094>
<https://nvd.nist.gov/vuln/detail/CVE-2024-3094>
<https://www.openwall.com/lists/oss-security/2024/03/29/4>
<https://www.redhat.com/en/blog/urgent-security-alert-fedora-41-and-rawhide-users>

### [Urgent security alert for Fedora Linux 40 and Fedora Rawhide users](https://www.redhat.com/en/blog/urgent-security-alert-fedora-41-and-rawhide-users)

Editor's note: This post has been updated to more clearly articulate the affected versions of Fedora Linux and add additional mitigation methods.

Yesterday, Red Hat Information Risk and Security and Red Hat Product Security learned that the latest versions of the “xz” tools and libraries contain malicious code that appears to be intended to allow unauthorized access. Specifically, this code is present in versions 5.6.0 and 5.6.1 of the libraries. Fedora Linux 40 users may have received version 5.6.0, depending on the timing of system updates. Fedora Rawhide users may have received version 5.6.0 or 5.6.1. This vulnerability was assigned CVE-2024-3094.

PLEASE IMMEDIATELY STOP USAGE OF ANY FEDORA RAWHIDE INSTANCES for work or personal activity. Fedora Rawhide will be reverted to xz-5.4.x shortly, and once that is done, Fedora Rawhide instances can safely be redeployed. Note that Fedora Rawhide is the development distribution of Fedora Linux, and serves as the basis for future Fedora Linux builds (in this case, the yet-to-be-released Fedora Linux 41).

At this time the Fedora Linux 40 builds have not been shown to be compromised. We believe the malicious code injection did not take effect in these builds. However, Fedora Linux 40 users should still downgrade to a 5.4 build to be safe. An update that reverts xz to 5.4.x has recently been published and is becoming available to Fedora Linux 40 users through the normal update system. Concerned users can force the update by following the instructions at <https://bodhi.fedoraproject.org/updates/FEDORA-2024-d02c7bb266>.

#### What is xz?

xz is a general purpose data compression format present in nearly every Linux distribution, both community projects and commercial product distributions. Essentially, it helps compress (and then decompress) large file formats into smaller, more manageable sizes for sharing via file transfers.

#### What is the malicious code?

The malicious injection present in the xz versions 5.6.0 and 5.6.1 libraries is obfuscated and only included in full in the download package - the Git distribution lacks the M4 macro that triggers the build of the malicious code. The second-stage artifacts are present in the Git repository for the injection during the build time, in case the malicious M4 macro is present.

The resulting malicious build interferes with authentication in sshd via systemd.  SSH is a commonly used protocol for connecting remotely to systems, and sshd is the service that allows access.  Under the right circumstances this interference could potentially enable a malicious actor to break sshd authentication and gain unauthorized access to the entire system remotely.

#### What distributions are affected by this malicious code?

Current investigation indicates that the packages are only present in Fedora 41 and Fedora Rawhide within the Red Hat community ecosystem.

No versions of Red Hat Enterprise Linux (RHEL) are affected.

We have reports and evidence of the injections successfully building in xz 5.6.x versions built for Debian unstable (Sid). Other distributions may also be affected. Users of other distributions should consult with their distributors for guidance.

#### What should I do if I am running an affected distribution?

For both personal and business activities, immediately stop using Fedora 41 or Fedora Rawhide. If you are using an affected distribution in a business setting, we encourage you to contact your information security team for next steps.

Additionally, for those running openSUSE distributions, SUSE has published a downgrade procedure at <https://build.opensuse.org/request/show/1163302>

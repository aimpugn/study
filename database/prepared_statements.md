# Prepared statements

## prepared statements?

Prepared Statements는 SQL 쿼리를 컴파일 한 번 하고, 그 후에는 파라미터만 바꿔가며 여러 번 실행할 수 있게 하는 기능이다.
이는 데이터베이스에 쿼리를 실행할 때, 쿼리의 구조를 미리 컴파일하고 실행 시점에 파라미터만 전달하는 방식이다.
이 방법은 SQL 인젝션 공격을 방지하고, 쿼리 실행 성능을 향상시키는 데 도움이 된다.

### Prepare는 무엇인가?

`Prepare`는 Prepared Statement를 생성하는 과정이다.
이 과정에서 데이터베이스는 제공된 쿼리의 구문을 분석하고, 실행 계획을 생성한다.
그 후, 실제 쿼리 실행 시에는 이 실행 계획을 재사용하고, 쿼리에 전달된 파라미터 값만 바꿔서 실행한다.

## 지원하게 된 이유

Prepared Statements는 다음과 같은 이유로 지원하게 되었습니다:

1. **보안**: SQL 인젝션 공격을 방지합니다. 사용자 입력을 쿼리의 파라미터로 전달하기 때문에, 악의적인 SQL 코드가 쿼리에 주입되는 것을 방지할 수 있습니다.
2. **성능**: 쿼리의 구조가 미리 컴파일되어 있기 때문에, 같은 쿼리 구조를 반복해서 실행할 때 성능이 향상됩니다. 파싱, 컴파일, 실행 계획 생성 등의 과정이 한 번만 수행되기 때문입니다.
3. **편의성**: 파라미터를 통해 쿼리에 값을 전달하기 때문에, 쿼리 문자열을 동적으로 생성할 필요가 없습니다. 이는 코드의 가독성과 유지보수성을 향상시킵니다.

## 어떤 DB에서 Prepare를 지원하나?

대부분의 현대적인 관계형 데이터베이스 시스템(RDBMS)은 Prepared Statements를 지원합니다. 예를 들어:

- MySQL
- PostgreSQL
- SQLite
- Oracle
- Microsoft SQL Server
- 등등

## 지원하는 경우 DB 내부에서 어떻게 작동하는가?

1. **컴파일**:
    - 클라이언트가 Prepare 명령과 함께 SQL 쿼리를 데이터베이스 서버로 전송한다. 데이터베이스 서버는 이 쿼리를 분석하고, 실행 계획을 생성하며, 필요한 경우 쿼리를 최적화한다.
    - 데이터베이스는 쿼리의 구문을 분석하고, 유효성을 검사한 후 실행 계획을 생성한다.
    - 이 과정에서 쿼리가 데이터베이스의 스키마와 일치하는지, 사용된 함수와 연산자가 유효한지 등을 확인한다.
2. **실행 계획 생성**:
    - 데이터베이스는 쿼리를 가장 효율적으로 실행하기 위한 경로를 결정한다.
    - 이는 인덱스 사용 여부, 조인 방식, 데이터 접근 순서 등을 포함할 수 있다.
3. **파라미터 바인딩**:
    - 실행 시점에, 애플리케이션은 쿼리의 파라미터 값을 데이터베이스에 전달한다.
    - 데이터베이스는 이 값을 쿼리의 해당 위치에 바인딩한다.
4. **실행**:
    - 준비된 실행 계획에 따라 쿼리가 실행된다.
    - 이 과정에서 데이터베이스는 필요한 데이터를 검색하고, 결과를 애플리케이션에 반환한다.

# MySQL5.5 Online Large Indexing

## 상황

- A table

    ```text
    TABLE_ROWS: 439912614
    DATA_LENGTH: 63.91 GB
    INDEX_LENGTH: 29.3 GB
    ```

- B table

    ```text
    TABLE_ROWS: 155985963
    DATA_LENGTH: 15.79 GB
    INDEX_LENGTH: 16.86 GB
    ```

두 개의 테이블이 각각 약 4억 4천만 건, 1억 5천만건 정도의 사이즈.
그런데 인덱스를 추가하는 것에 대해 문의.
해당 DB는 서비스 핵심 DB로서, 만약 문제가 생기면 서비스 전체에 장애 발생

## 생각

MySQL 5.5에서 대규모 테이블에 새로운 인덱스를 생성하는 것은 주의가 필요하며, 특히 지금처럼 수억 개의 로우가 있는 테이블과 이미 높은 메모리 사용률을 가진 시스템에서는 더욱 주의를 해야 한다

### 1. 성능 저하 및 락(Lock)

- 인덱스 생성 중 락:
    - MySQL 5.5에서는 인덱스를 생성할 때 해당 테이블에 대한 락이 발생할 수 있다
    - 이는 테이블이 크면 클수록 락이 잡히는 시간이 길어져, 해당 테이블에 대한 읽기 및 쓰기 작업이 지연될 수 있다
- 성능 저하:
    - 인덱스 생성은 리소스 집약적인 작업이며, 디스크 I/O와 CPU 사용량이 증가할 수 있고, 이는 시스템 전반의 성능 저하로 이어질 수 있다

### 2. 메모리 사용량 증가

- 메모리 사용률: 이미 높은 메모리 사용률을 보이고 있는 시스템에서 인덱스 생성 작업은 추가적인 메모리 부하를 발생시킬 수 있습니다. 인덱스 생성 과정에서 발생하는 추가 메모리 사용은 시스템의 성능 저하나 메모리 관련 문제를 유발할 수 있습니다.

### 3. 디스크 공간 사용

- 디스크 공간: 새로운 인덱스는 추가적인 디스크 공간을 사용합니다. 대규모 테이블에서는 이 공간이 상당히 클 수 있으므로, 충분한 디스크 공간이 있는지 확인하는 것이 중요합니다.

### 대응 전략

- 저하효과 최소화: 가능하다면, 인덱스 생성 작업을 트래픽이 적은 시간대에 수행하는 것이 좋습니다.
- 점진적 실행: 인덱스 생성을 여러 단계로 나누어 수행하거나, 더 작은 트랜잭션으로 분할하여 시스템에 미치는 영향을 최소화할 수 있습니다.
- 리소스 모니터링: 인덱스 생성 동안 시스템의 CPU, 메모리, 디스크 I/O 등을 면밀히 모니터링하며, 문제가 발생하면 즉시 대응할 수 있도록 준비합니다.
- 백업: 인덱스 생성 전에 데이터를 백업하여, 만약의 사태에 대비합니다.
- 테스트 환경에서 시뮬레이션: 가능하다면 테스트 환경에서 먼저 인덱스 생성을 시도하여 예상되는 영향을 평가합니다.

### 마무리

새로운 인덱스를 생성하기 전에 테이블의 크기, 시스템의 현재 리소스 사용률, 필요한 디스크 공간 등을 면밀히 검토하는 것이 중요합니다. 또한, 인덱스 생성 작업을 수행하기 전에 충분한 계획과 준비를 하는 것이 필수적입니다. 가능한 한 위험을 최소화하고, 문제 발생 시 빠르게 대응할

 수 있는 전략을 수립해야 합니다.

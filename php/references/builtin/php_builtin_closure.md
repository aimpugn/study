# PHP builtin Closure

- [PHP builtin Closure](#php-builtin-closure)
    - [클로저](#클로저)
    - [`use` 키워드](#use-키워드)
    - [캡슐화, 캡처, 스냅샷](#캡슐화-캡처-스냅샷)

## 클로저

`captureData` 함수는 클로저를 반환하는 함수입니다.

```php
private function captureData($data)
{
    return function () use ($data) {
        return $data;
    };
}
```

1. 클로저의 정의:
   - 클로저는 자신이 생성될 때의 환경을 기억하는 익명 함수입니다.
   - 여기서는 `function () use ($data) { ... }` 부분이 클로저입니다.

2. `use ($data)` 구문:
   - 이 구문은 클로저가 생성될 때의 `$data` 변수를 클로저 내부로 가져옵니다.
   - 이를 통해 클로저는 자신이 생성된 시점의 `$data` 값을 "캡처"하고 유지합니다.

3. 값의 복사 vs 참조:
   - 기본적으로 `use`로 가져온 변수는 값으로 복사됩니다. 즉, 클로저 내부의 `$data`는 원본 `$data`의 복사본입니다.
   - 만약 참조로 가져오고 싶다면 `use (&$data)`와 같이 사용할 수 있습니다만, 이 경우에는 그렇게 하지 않았습니다.

4. 클로저의 동작:
   - 이 클로저는 호출될 때 단순히 캡처된 `$data`를 반환합니다.
   - `return $data;`는 클로저가 실행될 때 캡처된 데이터를 그대로 반환한다는 의미입니다.

5. 데이터의 불변성:
   - 이 방식으로 데이터를 캡처하면, 클로저가 생성된 이후에 원본 `$data`가 변경되더라도 클로저 내부의 `$data`는 변경되지 않습니다.
   - 이는 데이터의 특정 시점 스냅샷을 유지하는 데 유용합니다.

6. 지연 실행:
   - 클로저는 `captureData` 함수가 호출될 때 생성되지만, 실제로 실행되는 것은 나중에 이 클로저를 호출할 때입니다.
   - 이를 통해 데이터의 접근을 제어하고 필요한 시점에만 데이터를 불러올 수 있습니다.

7. 메모리 관리:
   - 클로저는 캡처한 변수들을 메모리에 유지합니다. 따라서 큰 데이터 구조를 캡처할 경우 메모리 사용에 주의해야 합니다.

8. 사용 사례:
   - 이러한 패턴은 특정 시점의 데이터 상태를 보존하고 싶을 때 유용합니다.
   - 예를 들어, 비동기 작업에서 현재 상태를 캡처하여 나중에 사용하거나, 테스트에서 특정 시점의 데이터를 검증할 때 활용할 수 있습니다.

이 클로저를 통해 데이터를 캡슐화함으로써, 데이터의 상태를 안전하게 보존하고 필요한 시점에 접근할 수 있는 메커니즘을 제공합니다. 이는 데이터의 일관성을 유지하고 부작용을 최소화하는 데 도움이 됩니다.

## `use` 키워드

PHP에서 `use` 키워드는 클로저(익명 함수)와 함께 사용되며, 클로저가 정의된 범위 외부의 변수를 클로저 내부로 "가져오는" 역할을 합니다.
이를 통해 클로저 내부에서 외부 변수에 접근할 수 있게 됩니다.

- 클로저 외부의 변수를 클로저 내부 스코프로 가져옵니다.
- 가져온 변수는 클로저 내부에서 읽기 전용으로 사용됩니다 (기본적으로).
- 변수를 참조로 가져오려면 `use (&$variable)` 형태로 사용합니다.
- 여러 변수를 가져올 때는 쉼표로 구분합니다: `use ($var1, $var2, $var3)`
- PHP 7.1 이상에서는 타입 힌트를 사용할 수 있습니다: `use (int $var1, string $var2)`

```php
$this->SomeComponent->SomeModel
    ->expects($this->once())
    ->method('save')
    ->with(
        $this->callback(function ($saveData) use (
            $expectedParam1,
            $expectedParam2
        ) {
            // 저장될 데이터($saveData)가 기대하는 값들과 일치하는지 검증합니다.
            if (!$saveData) {
                return false;
            }
            
            if ($saveData['column_1'] !== $expectedParam1) {
                return false;
            }
            
            // 추가적인 검증 로직...
            
            return true; // 모든 검증을 통과한 경우
        })
    );
```

## 캡슐화, 캡처, 스냅샷

1. 캡처 (Capture):
   - 의미: 클로저가 생성될 때 주변 환경의 변수를 "잡아두는" 것을 의미합니다.
   - 특징:
     - 클로저의 핵심 기능입니다.
     - 변수의 현재 상태를 클로저 내부로 가져옵니다.
   - 예시 코드에서: `use ($data)`가 데이터를 캡처하는 부분입니다.

2. 스냅샷 (Snapshot):
   - 의미: 특정 시점의 데이터 상태를 그대로 보존하는 것을 의미합니다.
   - 특징:
     - 시간의 특정 순간을 "찍어두는" 것과 유사합니다.
     - 원본 데이터가 변경되어도 스냅샷은 변하지 않습니다.
   - 예시 코드에서: 클로저가 생성되는 시점의 `$data` 상태가 스냅샷입니다.

3. 캡슐화 (Encapsulation):
   - 의미: 데이터와 그 데이터를 다루는 동작을 하나의 단위로 묶는 것을 의미합니다.
   - 특징:
     - 객체 지향 프로그래밍의 핵심 개념 중 하나입니다.
     - 데이터에 대한 접근을 제어하고 내부 구현을 숨깁니다.
   - 예시 코드에서: 데이터를 클로저 내부에 넣고, 클로저를 통해서만 접근할 수 있게 하는 전체 과정이 캡슐화입니다.

이 세 개념의 관계:

1. 클로저는 주변 환경의 변수를 *캡처*합니다.
2. 캡처된 데이터는 해당 시점의 *스냅샷*이 됩니다.
3. 이 스냅샷을 클로저 내부에 넣고 클로저를 통해서만 접근할 수 있게 함으로써 *캡슐화*가 이루어집니다.

예시 코드에서 이 세 개념이 어떻게 적용되는지 보겠습니다:

```php
private function captureData($data)
{
    return function () use ($data) {  // 캡처
        return $data;  // 스냅샷 반환
    };
}

// 사용
$captured = $this->captureData($someData);  // 캡슐화
```

- 캡처: `use ($data)`로 `$data`를 클로저 내부로 가져옵니다.
- 스냅샷: 클로저가 생성되는 시점의 `$data` 상태가 보존됩니다.
- 캡슐화: `$data`는 클로저 내부에 숨겨지고, 클로저를 통해서만 접근할 수 있습니다.

따라서 이 코드는 세 가지 개념을 모두 포함하고 있습니다.
데이터를 캡처하여 스냅샷을 만들고, 이를 클로저 내에 캡슐화하는 과정을 거칩니다.

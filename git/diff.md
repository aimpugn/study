# diff

- [diff](#diff)
    - [기본 문법](#기본-문법)
    - [git diff 결과 읽기](#git-diff-결과-읽기)
    - [다른지 같은지 파악하는 로직](#다른지-같은지-파악하는-로직)
        - [`git diff` 명령어의 내부 동작](#git-diff-명령어의-내부-동작)
        - [커밋 해시와 파일 내용의 관계](#커밋-해시와-파일-내용의-관계)
        - [예시 시나리오](#예시-시나리오)
            - [시나리오 1: 동일한 파일 내용, 다른 커밋 해시](#시나리오-1-동일한-파일-내용-다른-커밋-해시)
            - [시나리오 2: 다른 파일 내용, 동일한 커밋 해시](#시나리오-2-다른-파일-내용-동일한-커밋-해시)
            - [시나리오 3: 동일한 커밋 해시, 동일한 파일 내용](#시나리오-3-동일한-커밋-해시-동일한-파일-내용)
            - [시나리오 4: 파일 내용이 변경됨, 다른 커밋 해시](#시나리오-4-파일-내용이-변경됨-다른-커밋-해시)
    - [로컬과 remote 브랜치와의 비교](#로컬과-remote-브랜치와의-비교)
    - [단일 파일 차이점 보기: `--`](#단일-파일-차이점-보기---)
    - [변경된 파일명만 확인하기: `--name-status`](#변경된-파일명만-확인하기---name-status)
    - [스테이징된 변경 사항과 마지막 커밋 사이의 차이 보기: `--staged`](#스테이징된-변경-사항과-마지막-커밋-사이의-차이-보기---staged)

## 기본 문법

```bash
# git diff 인자 순서
# git diff [--options] <1st commit> <2nd commit> [--] [<path>...]
#                       │            └─ 베이스 커밋과 비교할 커밋
#                       └─ 베이스 커밋
# +∆x를 보여준다. 즉 추가된 내용
git diff <x> <x+∆x>
# -∆x를 보여준다. 즉 제거된 내용
git diff <x+∆x> <x>
```

```bash
# conflict, 충돌 파일 보기
# - https://stackoverflow.com/a/10874862
git diff --name-only --diff-filter=U --relative

git diff --check

# merge conflict resolve 시에 문제
```

## git diff 결과 읽기

```diff
diff --git a/file.txt b/file.txt
index e69de29..d95f3ad 100644
--- a/file.txt
+++ b/file.txt
@@ -1,1 +1,2 @@
 New line
+Another new line from remote
```

- `diff --git a/file.txt b/file.txt`

    diff --git은 Git에서 두 파일을 비교하고 있음을 나타냅니다.
    a/file.txt b/file.txt는 비교되는 파일의 경로를 나타냅니다.
    여기서 a와 b는 비교되는 두 버전을 의미합니다.

- `index e69de29..d95f3ad` 100644

    `index e69de29..d95f3ad`는 두 파일의 해시 값을 나타냅니다.
    `index <이전 버전 파일 해시>..<변경 후 파일의 해시>` 형식으로 나타냅니다.
    이 해시 값은 파일의 내용을 기준으로 생성된 고유한 식별자입니다.
    - `e69de29`는 이전 버전의 파일 해시 값입니다.
    - `d95f3ad`는 변경 후 파일의 해시 값입니다.

    `100644`는 파일의 권한을 나타냅니다.
    여기서 `100644`는 일반 파일을 의미하며, 755 같은 값은 실행 가능한 파일을 나타낼 수 있습니다.

- `--- a/file.txt 및 +++ b/file.txt`

    - `--- a/file.txt`는 비교에서 기준이 되는 파일(변경 전 파일)을 나타냅니다.
    - `+++ b/file.txt`는 비교에서 변경된 파일(변경 후 파일)을 나타냅니다.

- `@@ -1,1 +1,2 @@`
  
    - `@@`로 시작하는 줄은 "hunk header" 또는 "hunk marker"라고 불리며, 변경 사항의 위치를 나타냅니다.
    - `-1,1`:
        - `-1`은 이전 파일의 변경이 시작되는 줄 번호입니다.
        - `1`은 이전 파일에서 영향을 받는 줄 수를 나타냅니다.
    - `+1,2`:
        - `+1`은 새로운 파일의 변경이 시작되는 줄 번호입니다.
        - `2`는 새로운 파일에서 영향을 받는 줄 수를 나타냅니다.

- 변경 내용
    - `New line`은 변경되지 않은 줄입니다.
    - `+Another new line from remote`은 추가된 줄입니다. 앞에 `+`가 붙어있습니다. 만약 `-`가 붙어있는 줄이 있다면 이는 삭제된 줄을 나타냅니다.

## 다른지 같은지 파악하는 로직

`git diff` 명령어는 커밋 해시를 비교하는 것이 아니라 *실제 파일의 내용을 비교*합니다.
`git diff --staged` 명령어는 스테이징된 변경 사항과 마지막 커밋의 파일 내용을 비교합니다.

동일한 커밋 해시나 다른 커밋 해시는 중요하지 않습니다.
중요한 것은 실제 파일의 내용입니다.
파일 내용이 변경되지 않았다면 `git diff`는 변경 사항이 없다고 판단합니다.

### `git diff` 명령어의 내부 동작

`git diff` 명령어는 파일의 실제 내용을 비교합니다. 이 비교는 다음과 같은 과정으로 이루어집니다:

1. 스냅샷 생성:

    Git은 각 커밋에서 파일들의 스냅샷을 저장합니다.
    스테이징된 변경 사항 역시 스냅샷으로 저장됩니다.

2. 파일 내용 비교:

    `git diff`는 두 스냅샷 간의 파일 내용을 비교합니다.
    이는 각 파일의 줄 단위로 차이점을 찾아내어 표시합니다.

3. 해시 비교가 아닌 내용 비교:

    Git은 두 스냅샷의 해시를 비교하지 않습니다.
    대신, 파일의 내용이 변경되었는지 여부를 직접 비교합니다.

### 커밋 해시와 파일 내용의 관계

- 커밋 해시

    커밋 해시는 커밋의 *메타데이터*와 *스냅샷*의 내용에 의해 결정됩니다.

    *메타데이터*
    - 커밋 메시지
    - 부모 커밋 해시
    - 작성자
    - 날짜 등

    *스냅샷의 내용*
    - 트리 해시

    따라서, 같은 파일 내용이라도 커밋 해시가 다를 수 있습니다.

- 파일 내용 비교

    `git diff`는 커밋 해시를 비교하는 것이 아니라 파일의 내용(스냅샷)을 비교합니다.
    파일 내용이 동일하다면 `git diff`는 변경 사항이 없다고 판단합니다.

### 예시 시나리오

#### 시나리오 1: 동일한 파일 내용, 다른 커밋 해시

- 상황:

    커밋 `A`: 파일 `foo.txt`의 내용이 "Hello, World!"

    커밋 `B`: 파일 `foo.txt`의 내용이 "Hello, World!" (메타데이터만 변경됨)

- 비교 결과:

    `git diff A B`: 변경 사항이 없음. (파일 내용이 동일하므로 변경 사항이 없다고 판단)

#### 시나리오 2: 다른 파일 내용, 동일한 커밋 해시

- 이 경우는 불가능합니다. 파일 내용이 다르면 커밋 해시도 다릅니다.

#### 시나리오 3: 동일한 커밋 해시, 동일한 파일 내용

- 상황:

    커밋 `A`와 커밋 `B`가 동일한 해시를 가지고 있음 (즉, 동일한 파일 내용과 메타데이터)

- 비교 결과:

    `git diff A B`: 변경 사항이 없음. (해시가 동일하므로 파일 내용도 동일)

#### 시나리오 4: 파일 내용이 변경됨, 다른 커밋 해시

- 상황:

    커밋 `A`: 파일 `foo.txt`의 내용이 "Hello, World!"

    커밋 `C`: 파일 `foo.txt`의 내용이 "Hello, Git!"

- 비교 결과:

    `git diff A C`: 변경 사항이 있음. (파일 내용이 다르므로 변경 사항이 있다고 판단)

## 로컬과 remote 브랜치와의 비교

```bash
# remote 저장소에 있는 최신 변경 사항을 로컬에 반영하지 않고, 변경 정보만 가져온다
git fetch origin

# 로컬 파일과 remote 브랜치의 해당 파일을 직접 비교
# 출력이 없다면, 두 파일은 일치한다는 의미
git diff HEAD:src/main.java origin/master:src/main.java
```

```bash
# HEAD (현재 브랜치)와 origin/master 브랜치 간의 *전체 차이*를 비교하되, 
# src/main.java 파일에 대한 차이점만을 출력
git diff HEAD origin/master -- src/main.java
```

## 단일 파일 차이점 보기: `--`

- 단일 파일 차이점 보기. `--`은 없어도 된다

```bash
# - https://stackoverflow.com/a/4099805
git diff origin/main origin/feature/my-branch -- filename.ext
```

## 변경된 파일명만 확인하기: `--name-status`

```shell
git diff origin/main origin/feature/my-branch --name-status | cat
```

## 스테이징된 변경 사항과 마지막 커밋 사이의 차이 보기: `--staged`

`--staged` 옵션은 스테이징된 변경 사항과 마지막 커밋 사이의 차이를 보여줍니다.
커밋할 준비가 된 파일의 변경 사항을 검토하고 스테이징된 파일이 커밋될 준비가 되었는지 검토할 때 유용합니다.
`--cached` 옵션은 `--staged`와 동일한 기능을 합니다.

- 스테이징된 변경 사항과 마지막 커밋의 차이를 비교:

  ```sh
  git diff --staged
  ```

- 또는:

  ```sh
  git diff --cached
  ```

# k8s

## unauthorized trying to getAll /v1 K8sNamespace(${NAME_SPACE})/pods

### 문제

```log
unauthorized trying to getAll /v1 K8sNamespace(transaction-service)/pods
```

- Kubernetes API에 접근 권한이 없음 의미
    - 토큰이 만료
    - 또는 기타 이유로 유효하지 않음

### 원인

```text
클러스터 토폴로지에 변함이 없을 때는 shard manager가 k8s API 찌를 일이 없어서 저렇게 토큰이 만료되어도 아무 문제가 발생하지 않는데, 새로 배포를 한다던가 오토스케일링을 한다던가 할 때 비로소 문제가 발생하는 것 같음
```

- 이 사례를 분석하기 위해서는 여러 개념을 이해해야 함
    - Kubernetes (k8s) 클러스터
    - 클러스터 토폴로지
    - Kubernetes API
    - 토큰 만료
    - 롤링 업데이트
    - 오토스케일링 등

#### Kubernetes 클러스터와 클러스터 토폴로지

- Kubernetes 클러스터:
    - Kubernetes는 컨테이너화된 애플리케이션을 자동으로 배포, 확장 및 관리하는 오픈소스 시스템
    - 클러스터는 여러 노드(서버)의 집합체로, 이 노드들에서 컨테이너화된 애플리케이션을 실행한다
- 클러스터 토폴로지
    - **클러스터 내의 노드 배치와 네트워크 구성**을 의미
    - 이 토폴로지는 클러스터의 리소스 관리와 효율성에 영향을 미친다

#### 문제의 원인 분석

- 클러스터 토폴로지에 변화가 없으면, tx-shard-manager는 Kubernetes API에 접근할 필요가 없다
- 그러나 새로운 배포, 오토스케일링, 롤링 업데이트 등 **클러스터의 상태 변화**가 있을 때 Kubernetes API에 접근해야 한다
- 이때 토큰이 만료되어 있으면, 이러한 작업들이 실패

### 해결

- 재시작을 통한 임시 해결:
    - 해당 서비스를 재시작함으로써 새로운 토큰을 받아 문제를 임시적으로 해결
    - 이는 토큰을 갱신하는 효과를 가져왔을 것
- 롤링 업데이트와 로그 모니터링
    - 롤링 업데이트는 애플리케이션을 업데이트할 때 서비스 중단 없이 순차적으로 노드를 업데이트하는 방식
    - 이 과정에서 tx-shard-manager의 로그를 모니터링하여 권한 문제가 다시 발생하지 않도록 하는 것이 중요하다
- 장기적 해결책
    - 토큰 만료 문제를 근본적으로 해결하기 위해서는 토큰 갱신 로직을 검토하고, 필요한 경우 자동 갱신 메커니즘을 구현

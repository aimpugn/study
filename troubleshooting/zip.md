# troubleshooting - zip

## 같은 볼륨을 원본 및 대상으로 사용할 수 없습니다

### 문제

맥북에서 다음 명령어로 분할 압축을 실행했습니다.

```sh
zip -r -s 60m PowerShell-7.5.0-win-x64 PowerShell-7.5.0-win-x64.zip
```

그리고 정상적으로 분할 압축이 되었습니다.

```sh
❯ ll
total 227496
-rw-r--r--@ 1 rody  staff    60M  3 18 19:46 PowerShell-7.5.0-win-x64-split.z01
-rw-r--r--@ 1 rody  staff    50M  3 18 19:46 PowerShell-7.5.0-win-x64-split.zip
```

하지만 윈도우에서 `git pull`로 파일을 가져온 후 다시 압축을 해제하려고 하니 "같은 볼륨을 원본 및 대상으로 사용할 수 없습니다"라고 에러가 발생합니다.

### 원인

`zip` 명령어에는 `-s` 옵션은 "split"의 약자로, 압축 파일을 여러 개의 조각으로 나누는 옵션입니다.
예를 들어 `-s 60m`라고 하면 60MB 단위로 분할된 여러 개의 .zip 파일(정확히는 `.z01`, `.z02`, …, `.zip` 등)이 생성됩니다.

```sh
PowerShell-7.5.0-win-x64.z01
PowerShell-7.5.0-win-x64.z02
...
PowerShell-7.5.0-win-x64.zip
```

그런데 `-s` 옵션으로 생성되는 분할 압축 파일들은 단순히 개별 zip 파일들의 모음이 아니라, 하나의 '다중 볼륨(multivolume) 구조'로 구성된 형태라고 합니다.

"분할"된 각각의 조각들을 하나의 "체인"으로 인식하여, 해제하거나 재결합하려면 적절한 호환성(예: 동일한 zip 프로그램 또는 해당 형식을 이해하는 도구)이 필요합니다.

윈도우 탐색기의 '기본 압축 해제' 또는 일부 구버전 zip 유틸리티에서는 "[다중 볼륨 zip(Spanned ZIP Archive)](https://doc.xceed.com/xceed-zip-for-activex/Spanned_zip_files.html)"을 제대로 인식하지 못하거나, 이식을 제대로 지원하지 않는 경우가 많다고 합니다.

macOS 또는 리눅스에서 `zip` 명령어의 `-s` 옵션을 통해 만든 분할 zip 파일을 윈도우 탐색기의 '기본 압축 해제'로 압축 해제를 시도하면, "이 zip은 여러 볼륨으로 되어 있는데, 첫 번째 볼륨만 읽었다", 혹은 "볼륨이 분리되어 있는데 동일한 드라이브에 분할 볼륨을 쓰려고 한다" 등의 문제를 일으킬 수 있다고 합니다.
즉, 윈도우 입장에서 "여러 디스크(볼륨)에 존재해야 하는 파일인데 원본 볼륨과 대상 볼륨이 동일하니, 스팬(spanned) 복사가 아니다"라고 착각하여 오류를 발생시킨다고 합니다.

윈도우의 기본 zip 압축 풀기는 전통적으로 "여러 개의 디스켓(플로피 디스크)"로 나누어 저장하는 고전적 방식을 지원해야 했는데, 그것이 아주 정확하게 같은 방식으로 구현된 것이 아니거나, 혹은 버전에 따라서 불완전하게 지원되는 경우가 있다고 합니다.
그 결과, "같은 볼륨을 원본 및 대상으로 사용할 수 없습니다" 혹은 "원본 디스크와 대상으로 쓸 디스크가 달라야 합니다" 등의 이상한 오류가 발생할 수 있다고 합니다.

따라서, '맥에서 생성된 Spanned ZIP 파일 구조'를 윈도우 압축 해제가 완벽하게 지원하지 못하기 때문에 볼륨 충돌 관련 오류가 발생한다고 합니다.

> 같은 볼륨을 원본 및 대상으로 사용할 수 없습니다?
>
> 윈도우의 기본 압축 해제가 멀티 볼륨(Spanned ZIP)을 인식할 때, "분할 zip은 서로 다른 디스크(볼륨)에 분산되어 있다"는 전제 하에 동작하는 로직이 있기 때문이라고 합니다.
> 예전에는 플로피 디스크 A:, B:가 따로 존재했고, '원본 A: 디스크', '대상 B: 디스크'를 가정한 시나리오가 흔했습니다.
>
> 그러나 단순히 파일로 분할했을 뿐인데 과거 로직에 따라 '서로 다른 디스크로 스팬'되어야 하는데, '같은 경로에서 읽기/쓰기가 이뤄져서 이상하다'라고 오류를 내보내는 것이라고 합니다.

### 해결

`COPY /b`로 이진 결합 후 `zip -FF` 쓰면 파일 구조를 복원할 수 있다고 합니다.

```sh
copy /b PowerShell-7.5.0-win-x64.z01 + PowerShell-7.5.0-win-x64.z02 + ... + PowerShell-7.5.0-win-x64.zip combined.zip

zip -FF combined.zip --out fixed.zip
```

그러나 이 또한 *Windows에 zip(Info-ZIP)을 설치*해야 가능하고, 분할 방식이나 파일 헤더 구조가 조금만 달라도 실패할 수도 있다고 합니다.

대신 `split` 명령어 등 '단순 분할 툴'을 이용하여 '바이너리 분할'을 하고 `copy /b file.zip.part01 + file.zip.part02 + ... file.zip` 등으로 이진결합하여 원본 zip 파일로 복구하고 기본 압축 풀기로 압축 해제하는 게 가능하다고 합니다.

`zip -s` 방식은 사실상 여러 디스크(플로피 등)에 걸쳐서 배포해야 할 옛날 용도로 만들어진 전통 기능이기 때문에, 호환성 문제가 발생하기 쉽습니다.

다음 과정을 거쳐서 macOS에서 분할하고 윈도우에서 합쳐서 압축 해제를 성공하는 것을 확인할 수 있었습니다.

- macOS

    ```sh
    split -b 60m PowerShell-7.5.0-win-x64.zip PowerShell-7.5.0-win-x64.zip.part
    ```

- window

    `cmd` 창에서 다음 명령어를 실행합니다.
    `copy`는 기본적으로 `cmd` 내부 명령어이므로, `cmd`에서 더 자연스럽게 동작한다고 합니다.

    `copy`가 정상적으로 동작하는지 확인합니다.

    ```sh
    copy /?
    ```

    > 또는 PowerShell에서 다음과 같이 사용이 가능합니다.
    >
    > ```sh
    > cmd /c copy /?
    > ```

    ```sh
    copy /b .\PowerShell-7.5.0-win-64.zip.part* PowerShell-7.5.0-win-x64.zip
    ```

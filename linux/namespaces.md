# Linux namepsaces

## [namespaces](https://man7.org/linux/man-pages/man7/namespaces.7.html)

> A namespace wraps a global system resource in an abstraction that makes it appear to the processes within the namespace that they have their own isolated instance of the global resource.
> Changes to the global resource are visible to other processes that are members of the namespace, but are invisible to other processes. One use of namespaces is to implement containers.

네임스페이스(namespace)는 전역 시스템 리소스를 추상화하여, 네임스페이스 내의 프로세스들이 전역 리소스의 독립된 인스턴스를 갖고 있는 것처럼 보이게 하는 기술입니다. 전역 리소스에 대한 변경사항은 같은 네임스페이스의 다른 프로세스에게는 보이지만, 다른 프로세스에게는 보이지 않습니다. 네임스페이스의 사용례 중 하나는 컨테이너를 구현하는 것입니다.

리눅스 네임스페이스는 운영체제 수준에서 프로세스 그룹에 대한 격리를 제공하는 기능으로, 각 네임스페이스는 특정 종류의 시스템 리소스를 가상화하고, 해당 네임스페이스 내의 프로세스들에게 독립된 리소스처럼 보이도록 한다.
이를 통해 프로세스들은 서로 다른 네임스페이스에서 실행되고 있음에도 불구하고, 자신만의 파일 시스템, 네트워크 인터페이스, 프로세스 ID 공간 등을 가지는 것처럼 작동할 수 있습니다. 네임스페이스는 리눅스 커널의 핵심 기능 중 하나로, 리소스 격리, 제한, 그리고 독립적인 환경을 생성하는 데 필수적입니다.

- **PID 네임스페이스**: 프로세스 ID를 격리하여, 각 네임스페이스 내에서 프로세스가 고유한 PID를 가질 수 있도록 합니다.
- **네트워크 네임스페이스**: 네트워크 인터페이스, IP 주소, 포트 번호 등 네트워크 리소스를 격리합니다.
- **마운트 네임스페이스**: 파일 시스템 마운트 포인트를 격리하여, 네임스페이스 내의 프로세스들이 별도의 파일 시스템 뷰를 가질 수 있습니다.
- **UTS 네임스페이스**: 호스트 이름과 도메인 이름을 네임스페이스별로 독립적으로 설정할 수 있게 합니다.
- **IPC 네임스페이스**: 프로세스 간 통신(IPC) 리소스를 격리합니다.
- **사용자 네임스페이스**: 사용자와 그룹 ID를 네임스페이스별로 격리하여, 네임스페이스 내에서의 루트 권한과 시스템의 나머지 부분에 대한 권한 분리를 가능하게 합니다.
- **시간 네임스페이스**: 시스템 클럭과 부팅 시간을 격리하여, 네임스페이스별로 시간을 독립적으로 설정할 수 있게 합니다.

네임스페이스는 컨테이너 기술의 근간을 이루며, 도커와 같은 컨테이너화 도구에서 핵심적인 역할을 한다.
컨테이너는 네임스페이스를 사용하여 호스트 시스템과는 독립된 환경을 제공함으로써, 애플리케이션과 그 의존성을 함께 묶어 포터블하고 일관된 방식으로 배포할 수 있도록 한다. 이러한 격리는 보안, 리소스 관리, 그리고 환경 일관성을 향상시키는 데 중요한 역할을 한다

## 상세 설명

이 문서는 리눅스 네임스페이스에 대한 상세한 설명을 제공합니다. 아래는 해당 내용의 번역입니다:

### 네임스페이스 타입

다음 표는 리눅스에서 사용 가능한 네임스페이스 타입을 보여준다.
표의 두 번째 열 `플래그`는 다양한 API에서 네임스페이스 타입을 지정하는 데 사용되는 플래그 값을 보여준다.
세 번째 열 `페이지`는 네임스페이스 타입에 대한 세부 정보를 제공하는 매뉴얼 페이지를 식별한다.
마지막 열 `격리하는 리소스`는 네임스페이스 타입에 의해 격리되는 리소스를 요약한다.

| 네임스페이스 | 플래그          | 페이지                | 격리하는 리소스               |
| :----------- | :-------------- | :-------------------- | :---------------------------- |
| Cgroup       | CLONE_NEWCGROUP | cgroup_namespaces(7)  | Cgroup 루트 디렉토리          |
| IPC          | CLONE_NEWIPC    | ipc_namespaces(7)     | System V IPC, POSIX 메시지 큐 |
| Network      | CLONE_NEWNET    | network_namespaces(7) | 네트워크 장치, 스택, 포트 등  |
| Mount        | CLONE_NEWNS     | mount_namespaces(7)   | 마운트 포인트                 |
| PID          | CLONE_NEWPID    | pid_namespaces(7)     | 프로세스 ID                   |
| Time         | CLONE_NEWTIME   | time_namespaces(7)    | 부팅과 모노토닉 클록          |
| User         | CLONE_NEWUSER   | user_namespaces(7)    | 사용자와 그룹 ID              |
| UTS          | CLONE_NEWUTS    | uts_namespaces(7)     | 호스트 이름과 NIS 도메인 이름 |

### 네임스페이스 API

/proc 파일들 외에도, 네임스페이스 API는 다음 시스템 호출을 포함합니다:

- **clone(2)**: `clone(2)` 시스템 호출은 새 프로세스를 생성합니다. 호출의 flags 인자가 위에 나열된 CLONE_NEW* 플래그 중 하나 이상을 지정하면, 각 플래그에 대해 새 네임스페이스가 생성되고 자식 프로세스는 해당 네임스페이스의 멤버가 됩니다. (이 시스템 호출은 네임스페이스와 관련 없는 여러 기능도 구현합니다.)
- **setns(2)**: `setns(2)` 시스템 호출을 통해 호출 프로세스는 기존 네임스페이스에 합류할 수 있습니다. 합류할 네임스페이스는 아래에 설명된 /proc/pid/ns 파일 중 하나를 참조하는 파일 디스크립터를 통해 지정됩니다.
- **unshare(2)**: `unshare(2)` 시스템 호출은 호출 프로세스를 새 네임스페이스로 이동합니다. 호출의 flags 인자가 위에 나열된 CLONE_NEW* 플래그 중 하나 이상을 지정하면, 각 플래그에 대해 새 네임스페이스가 생성되고 호출 프로세스는 해당 네임스페이스의 멤버가 됩니다. (이 시스템 호출은 네임스페이스와 관련 없는 여러 기능도 구현합니다.)
- **ioctl(2)**: 다양한 ioctl(2) 연산을 사용하여 네임스페이스에 대한 정보를 발견할 수 있습니다. 이 연산들은 ioctl_ns(2)에서 설명됩니다.

새 네임스페이스의 생성은 대부분의 경우 CAP_SYS_ADMIN 권한을 요구합니다. 왜냐하면, 새 네임스페이스에서 생성자는 다른 프로세스가 생성되거나 네임스페이스에 합류할 때 보이는 전역 리소스를 변경할 권한을 가지기 때문입니다. 사용자 네임스페이스는 예외입니다: 리눅스 3.8부터 사용자 네임스페이스를 생성하기 위한 특권은 필요하지 않습니다.

### /proc/pid/ns/ 디렉토리

각 프로세스는 setns(2)에 의해 조작될 수 있는 각 네임스페이스를 위한 하나의 항목을 포함하는 /proc/pid/ns/ 하위 디렉토리를 가집니다:

```bash
$ ls -l /proc/$$/ns | awk '{print $1, $9, $10, $11}'
total 0
lrwxrwxrwx. cgroup -> cgroup:[4026531835]
lrwxrwxrwx. ipc -> ipc:[4026531839]
lrwxrwxrwx. mnt -> mnt:[4026531840]
lrwxrwxrwx. net -> net:[4026531969]
lrwxrwxrwx. pid -> pid:[4026531836]
lrwxrwxrwx. pid_for_children -> pid:[4026531834]
lrwxrwxrwx. time -> time:[4026531834]
lrwxrwxrwx. time_for_children -> time:[4026531834]
lrwxrwxrwx. user -> user:[4026531837]
lrwxrwxrwx. uts -> uts:[4026531838]
```

이 디렉토리에서 파일 중 하나를 파일 시스템의 다른 곳에 바인드 마운트하는 것은 pid로 지정된 프로세스의 해당 네임스페이스를 프로세스가 네임스페이스에서 종료되어도 살아있게 유지합니다.

이 디렉토리에서 파일 중 하나를 열거나(또는 이러한 파일 중 하나에 바인드 마운트된 파일을 열면) pid로 지정된 프로세스의 해당 네임스페이스에 대한 파일 핸들이 반환됩니다. 이 파일 디스크립터가 열려 있는 한, 네임스페이스는 모든 프로세스가 네임스페이스에서 종료되어도 살아있습니다. 파일 디스크립터는 setns(2)에 전달될 수 있습니다.

리눅스 3.7 이하에서, 이러한 파일들은 하드 링크로 보였습니다. 리눅스 3.8부터, 이들은 심볼릭 링크로 나타납니다. 두 프로세스가 같은 네임스페이스에 있으면, 그들의 /proc/pid/ns/xxx 심볼릭 링크의 장치 ID와 inode 번호가 같을 것입니다. 응용 프로그램은 stat(2)에 의해 반환된 stat.st_dev와 stat.st_ino 필드를 사용하여 이를 확인할 수 있습니다. 이 심볼릭 링크의 내용은 다음 예와 같은 네임스페이스 타입과 inode 번호를 포함하는 문자열입니다:

```bash
$ readlink /proc/$$/ns/uts
uts:[4026531838]
```

이 하위 디렉토리의 심볼릭 링크는 다음과 같습니다:

- **/proc/pid/ns/cgroup** (리눅스 4.6부터): 이 파일은 프로세스의 cgroup 네임스페이스에 대한 핸들입니다.
- **/proc/pid/ns/ipc** (리눅스 3.0부터): 이 파일은 프로세스의 IPC 네임스페이스에 대한 핸들입니다.
- **/proc/pid/ns/mnt** (리눅스 3.8부터): 이 파일은 프로세스의 마운트 네임스페이스에 대한 핸들입니다.
- **/proc/pid/ns/net** (리눅스 3.0부터): 이 파일은 프로세스의 네트워크 네임스페이스에 대한 핸들입니다.
- **/proc/pid/ns/pid** (리눅스 3.8부터): 이 파일은 프로세스의 PID 네임스페이스에 대한 핸들입니다. 이 핸들은 프로세스의 수명 동안 영구적입니다(즉, 프로세스의 PID 네임스페이스 멤버십은 결코 변경되지 않습니다).
- **/proc/pid/ns/pid_for_children** (리눅스 4.12부터): 이 파일은 이 프로세스에 의해 생성된 자식 프로세스의 PID 네임스페이스에 대한 핸들입니다. 이것은 unshare(2)와 setns(2) 호출의 결과로 변경될 수 있으므로, 파일은 /proc/pid/ns/pid와 다를 수 있습니다. 심볼릭 링크는 네임스페이스에서 첫 번째 자식 프로세스가 생성된 후에만 값을 얻습니다. (그 전에는 readlink(2)의 심볼릭 링크가 빈 버퍼를 반환할 것입니다.)
- **/proc/pid/ns/time** (리눅스 5.6부터): 이 파일은 프로세스의 시간 네임스페이스에 대한 핸들입니다.
- **/proc/pid/ns/time_for_children** (리눅스 5.6부터): 이 파일은 이 프로세스에 의해 생성된 자식 프로세스의 시간 네임스페이스에 대한 핸들입니다. 이것은 unshare(2)와 setns(2) 호출의 결과로 변경될 수 있으므로, 파일은 /proc/pid/ns/time와 다를 수 있습니다.
- **/proc/pid/ns/user** (리눅스 3.8부터): 이 파일은 프로세스의 사용자 네임스페이스에 대한 핸들입니다.
- **/proc/pid/ns/uts** (리눅스 3.0부터): 이 파일은 프로세스의 UTS 네임스페이스에 대한 핸들입니다.

이 심볼릭 링크를 참조하거나 읽기(readlink(2))에 대한 권한은 ptrace 접근 모드 PTRACE_MODE_READ_FSCREDS 검사에 의해 관리됩니다; ptrace(2)를 보세요.

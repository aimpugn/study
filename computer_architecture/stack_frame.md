# Stack Frame

- [Stack Frame](#stack-frame)
    - [스택 프레임 (Stack Frame)](#스택-프레임-stack-frame)
    - [스택 프레임 설정 과정](#스택-프레임-설정-과정)
    - [스택 프레임의 사용](#스택-프레임의-사용)
    - [스택 프레임의 이점](#스택-프레임의-이점)

## 스택 프레임 (Stack Frame)

스택 프레임은 각 함수 호출마다 생성되는 메모리 영역입니다.
함수의 실행 컨텍스트를 저장하는 데 사용됩니다.
- 함수의 지역 변수
- 매개변수
- 반환 주소(호출자로 돌아갈 주소)
- 이전 스택 프레임에 대한 포인터 (BP) 등

함수 호출 간의 독립성 유지하고, 재귀 호출 지원하며, 지역 변수의 범위(scope) 관리합니다.

## 스택 프레임 설정 과정

```assembly
PUSHQ BP
MOVQ  SP, BP
```

이 두 명령어는 함수 프롤로그(function prologue)의 일부로써,
새로운 스택 프레임을 설정하는 표준적인 방법입니다.

1. `PUSHQ BP`:

    '호출 체인(call chain)'을 유지하기 위해 '이전 함수의 BP를 저장'합니다.
    즉, 이를 통해 함수 호출이 끝난 후 이전 함수의 스택 프레임으로 돌아갈 수 있습니다.

    현재의 Base Pointer(BP) 값을 스택에 저장합니다.
    Base Pointer(BP)는 이전 함수의 스택 프레임을 가리키는 포인터입니다.

    스택은 하향식으로 성장하므로, 이 명령어는 SP(Stack Pointer)를 (64비트 시스템 기준)8바이트 감소시킵니다.

2. `MOVQ SP, BP`:

    현재의 Stack Pointer(SP) 값을 Base Pointer(BP)에 복사합니다.
    이로써 새로운 BP가 현재 스택 프레임의 시작을 가리키게 되고, 새로운 스택 프레임의 '기준점'이 됩니다.

## 스택 프레임의 사용

스택 프레임이 설정된 후:

1. **지역 변수 접근**:
   - BP를 기준으로 음수 오프셋을 사용하여 접근합니다.
   - 예: `MOVQ -8(BP), AX`는 첫 번째 지역 변수의 값을 AX 레지스터로 로드합니다.

2. **매개변수 접근**:
   - BP를 기준으로 양수 오프셋을 사용하여 접근합니다.
   - 예: `MOVQ 16(BP), BX`는 첫 번째 매개변수의 값을 BX 레지스터로 로드합니다.

3. **새로운 스택 공간 할당**:
   - `SUBQ $N, SP`와 같은 명령어로 N바이트의 새로운 스택 공간을 할당합니다.

4. **함수 종료 시**:
   - `MOVQ BP, SP`: SP를 BP로 복원하여 로컬 변수 공간을 해제합니다.
   - `POPQ BP`: 이전 함수의 BP를 복원합니다.
   - `RET`: 반환 주소로 점프하여 호출자로 돌아갑니다.

## 스택 프레임의 이점

1. **지역성(Locality)**: 함수의 데이터가 메모리의 한 영역에 집중되어 캐시 효율성이 향상됩니다.

2. **보안**: 각 함수가 독립된 메모리 영역을 사용하여 버퍼 오버플로우 같은 공격을 어렵게 만듭니다.

3. **디버깅 용이성**: 스택 트레이스를 통해 함수 호출 히스토리를 쉽게 확인할 수 있습니다.

4. **재진입성(Reentrancy)**: 동일한 함수를 안전하게 재귀적으로 호출할 수 있습니다.

이러한 메커니즘을 통해 스택 프레임은 함수 호출의 컨텍스트를 안전하고 효율적으로 관리합니다. 이는 프로그램의 실행 흐름을 제어하고 지역 변수의 수명을 관리하는 데 중요한 역할을 합니다.

# BTRFS

## [BTRFS](https://btrfs.readthedocs.io/en/latest/Introduction.html)

BTRFS는 *B-tree 파일 시스템*(B-tree File System)의 약자로, *Linux*에서 사용되는 최신 파일 시스템입니다.
이 파일 시스템은 특히 *복사-온-쓰기 (Copy-on-Write, COW)* 기술을 기반으로 하며, 고급 기능을 제공하는 동시에 *장애 내성*, *복구* 및 *쉽고 간편한 관리*에 초점을 맞추고 있습니다.

## 주요 특징 및 장점

1. *스냅샷 (Snapshots)*: 파일의 전체 복사본을 만들지 않고도 시스템의 스냅샷을 생성할 수 있습니다. 즉, 스토리지 자원을 더 효율적으로 사용합니다.
2. *통합 볼륨 관리*: 소프트웨어 기반의 RAID0, RAID1, RAID10 등 지원을 포함한 통합 볼륨 관리 기능이 내장되어 있습니다.
3. *자체 복구 기능(Self-healing)*: 데이터와 메타데이터에 대한 체크섬을 통해 *silent data corruptions*을 자동으로 감지하고 복구할 수 있습니다.

## 기능 개요

### *Extent 기반 파일 저장*

- *Extent*는 파일 시스템에서 파일의 데이터가 저장되는 연속적인 블록 단위를 말합니다. BTRFS는 이 방식을 통해 파일 저장을 더욱 효율적으로 관리합니다.

### *최대 파일 크기*

- 이론적으로 *264 바이트*(16 엑사바이트, EiB) 크기의 파일을 저장할 수 있지만, *Linux VFS*의 제약으로 인해 실제 한계는 8 EiB입니다.

### *공간 효율적인 작은 파일 패킹 및 인덱스 디렉토리*

- 작은 파일들을 효율적으로 저장하고, 인덱스 디렉토리도 공간을 절약할 수 있도록 설계되었습니다.

### *동적 아이노드 할당*

- 전통적인 파일 시스템은 아이노드(inode)의 수가 고정되어 있지만, BTRFS는 필요할 때마다 동적으로 아이노드를 할당합니다.

### *스냅샷 및 서브볼륨*

- *쓰기 가능한 스냅샷*, *읽기 전용 스냅샷*, *서브볼륨*을 지원합니다. 서브볼륨은 내부적으로 독립적인 파일 시스템의 루트 역할을 합니다.

### *데이터와 메타데이터에 대한 체크섬 지원*

- *crc32c*, *xxhash*, *sha256*, *blake2b*와 같은 여러 해시 알고리즘을 통해 데이터 무결성을 보장합니다.

### *압축 기능*

- *ZLIB*, *LZO*, *ZSTD* 같은 압축 알고리즘을 사용하여 파일 시스템의 압축을 지원하며, 압축 여부를 결정하는 *휴리스틱(Heuristics)*을 포함합니다.

### *다중 장치 지원*

- 여러 장치를 통합 관리할 수 있는 기능이 내장되어 있습니다. RAID 구성과 유사한 파일 스트라이핑, 미러링, 스트라이핑 + 미러링 방식 등을 지원합니다.
    - *File Striping*: RAID 0과 유사한 방식으로 데이터를 여러 디스크에 분산해 저장하여 성능을 높입니다.
    - *File Mirroring*: RAID 1과 유사하게 데이터를 복사하여 저장하며, 최대 4개의 복사본을 지원합니다.
    - *File Striping + Mirroring*: RAID 10과 유사한 방식으로 성능과 내구성을 동시에 제공합니다.
    - *Single and Dual Parity*: RAID 5/6과 유사한 단일 또는 이중 패리티를 사용한 구성도 지원하나, 현재는 실험적인 기능이며 프로덕션 환경에서는 권장되지 않습니다.

### *SSD/NVMe (플래시 스토리지) 지원*

- *TRIM/Discard* 명령어를 통해 사용하지 않는 블록을 보고하여 플래시 메모리 최적화가 가능하며, 불필요한 *시크(seek) 최적화*를 피하고 쓰기 작업을 클러스터링하여 성능을 향상시킵니다.

### *백그라운드 스크럽 프로세스*

- 중복된 파일을 복구할 수 있는 오류를 탐지하고 수리하는 *스크럽(scrub)* 작업을 자동으로 실행합니다.

### *온라인 파일 시스템 디프래그먼테이션*

- 파일 시스템을 사용 중인 상태에서도 디프래그 작업을 수행할 수 있습니다.

### *오프라인 파일 시스템 검사*

- 파일 시스템을 마운트하지 않은 상태에서 파일 시스템의 무결성을 검사할 수 있습니다.

### *기존 파일 시스템에서의 변환*

- 기존 *ext2/3/4* 및 *reiserfs* 파일 시스템을 *BTRFS*로 인플레이스 방식(데이터를 옮기지 않고)으로 변환할 수 있습니다.

### *시딩 장치 지원*

- 읽기 전용 파일 시스템을 템플릿으로 사용하여 다른 BTRFS 파일 시스템을 시드하는 기능을 지원합니다. 템플릿 파일 시스템은 변경되지 않으며, 모든 수정 사항은 다른 장치에 기록됩니다.

### *서브볼륨 인식 할당량 지원*

- 서브볼륨 단위로 할당량(쿼터)을 설정하고 관리할 수 있습니다.

### *서브볼륨 변경 사항 전송 및 수신*

- 효율적인 증분 파일 시스템 백업 및 미러링을 위해 서브볼륨 간의 변경 사항을 전송하고 받을 수 있습니다.

### *배치 또는 비동기 중복 제거*

- 쓰기 후에 실행되는 배치 중복 제거 기능을 지원합니다.

### *스왑파일 지원*

- 스왑파일을 사용한 메모리 스와핑을 지원합니다.

### *메타데이터 검증*

- *트리 체크(tree-checker)*, *사전 읽기/사전 쓰기 메타데이터 검증*을 통해 데이터 무결성을 검증합니다.

### *Zoned 모드 지원*

- *SMR(Shingled Magnetic Recording)*, *ZBC(Zone Block Commands)*, *ZNS(Zone Namespace)* 등의 기법을 사용하는 디스크에 최적화된 할당 모드를 지원하며, *비존 장치(non-zoned devices)*에서도 에뮬레이션 방식으로 사용할 수 있습니다.

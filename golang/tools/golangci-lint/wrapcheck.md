# [wrapcheck](https://github.com/tomarrell/wrapcheck)

## wrapcheck?

외부 패키지의 오류가 반환 중에 래핑되는지 확인하는 간단한 Go 린터로 디버깅 중에 오류 원인을 식별하는 데 도움이 됩니다.

## Wrapcheck란 무엇인가요?

`wrapcheck`는 Go 언어에서 사용되는 정적 분석 도구 중 하나입니다.
이 도구는 코드에서 반환된 에러가 적절하게 래핑되었는지(즉, 에러가 추가적인 컨텍스트와 함께 반환되었는지) 확인하는 데 사용됩니다.

에러 래핑은 에러의 원인과 위치에 대한 추가 정보를 제공하여 디버깅을 용이하게 만들어 줍니다.

## Wrapcheck의 원리와 도입 배경

Go 1.13 버전에서는 `fmt.Errorf`의 `%w` 포맷 지시어를 사용하여 에러를 래핑하는 기능이 소개되었습니다.
이를 통해 하위 에러를 포함하는 새로운 에러를 생성할 수 있으며, 이러한 에러들은 `errors.Unwrap`, `errors.Is`, `errors.As` 함수를 사용하여 검사할 수 있습니다.

`wrapcheck` 도구는 함수나 메서드에서 반환되는 에러가 외부 패키지나 표준 라이브러리에서 오는 경우, 이 에러가 호출자에게 전파되기 전에 래핑되어 추가적인 컨텍스트 정보를 제공하는지를 체크합니다. 이를 통해 에러 처리를 표준화하고, 에러 발생 시 추적과 디버깅을 용이하게 하려는 목적으로 도입되었습니다.

## 체크할 때의 장점과 안 할 때의 단점

**장점:**
- **더 나은 에러 정보**: 에러를 래핑함으로써, 에러의 원인과 위치에 대한 더 많은 정보를 제공할 수 있습니다. 이는 에러의 진단과 해결을 쉽게 만들어 줍니다.
- **일관된 에러 핸들링**: 프로젝트 전반에 걸쳐 일관된 에러 핸들링 접근 방식을 유도할 수 있습니다. 이는 코드의 가독성과 유지 관리를 향상시킵니다.

**단점:**
- **오버헤드**: 모든 에러를 래핑하려고 할 때 추가적인 코드 작성이 필요하며, 때로는 불필요하게 복잡해질 수 있습니다.
- **성능 저하**: 불필요한 에러 래핑은 성능에 영향을 줄 수 있으며, 특히 많은 에러가 발생하는 시스템에서는 더욱 그렇습니다.

`wrapcheck` 경고는 인터페이스 메서드에서 반환된 에러가 외부 라이브러리나 패키지로부터 반환된 경우, 추가적인 컨텍스트 없이 그대로 반환되는 것을 지적하는 것입니다. 이러한 경고는 더 나은 에러 핸들링과 에러 추적을 위해 에러를 래핑하라는 권장사항을 나타냅니다.

## 에러 래핑의 잠재적 영향

1. **에러 정보의 과도한 노출**:

    에러를 래핑할 때는 종종 추가적인 컨텍스트나 메시지를 포함시킵니다.
    이 정보가 과도하게 노출되면, 사용자에게 혼란을 줄 수 있거나 보안상의 문제가 될 수 있습니다.

    예를 들어, 구현 세부사항이 노출되어 공격자가 시스템의 취약점을 찾는 데 도움이 될 수 있습니다.

2. **성능 저하**:

    각 에러를 래핑할 때마다 새로운 에러 객체를 생성하고 추가적인 문자열 포맷팅을 수행해야 합니다.
    이는 성능에 미미한 영향을 줄 수 있으며, 에러가 빈번히 발생하는 시스템에서는 이러한 비용이 누적될 수 있습니다.

3. **에러 처리 로직의 복잡성 증가**:

    에러를 래핑하면 `errors.Is`와 `errors.As`와 같은 함수를 사용하여 원래의 에러 타입이나 값을 검사해야 합니다.
    이는 에러 처리 로직을 더 복잡하게 만들 수 있으며, 실수로 인한 버그의 원인이 될 수 있습니다.

4. **호환성 문제**:

    일부 라이브러리나 프레임워크는 특정 에러 타입을 기대할 수 있습니다.
    에러를 래핑하면 원래의 에러 타입이 숨겨지거나 변경될 수 있어, 예상치 못한 방식으로 함수나 메서드가 실패할 수 있습니다.

## 최선의 실천 방법

- **적절한 래핑 사용**

    모든 에러를 무조건 래핑하기보다는, 추가적인 컨텍스트나 정보가 실제로 유용할 때만 에러를 래핑하세요.
    에러 메시지에는 필요한 정보만 포함시키고, 구현 세부사항이나 민감한 정보의 노출은 피하십시오.

- **라이브러리와 프레임워크의 문서 검토**

    사용 중인 외부 코드의 문서를 검토하여, 특정 에러 타입이 요구되는지 확인하고, 에러 래핑이 이에 어떤 영향을 줄 수 있는지 이해하십시오.

- **에러 래핑의 단위 테스트**

    에러를 래핑하는 코드에 대한 충분한 단위 테스트를 수행하여, 예상치 못한 동작이나 버그가 없는지 확인하십시오.

에러 래핑은 적절히 사용될 때 매우 유용할 수 있습니다. 하지만 그 사용은 신중하게 고려되어야 하며, 애플리케이션의 컨텍스트와 요구 사항에 맞게 조정되어야 합니다.

## 에러 래핑 방법

위의 코드에서 `wrapcheck`가 에러를 잡은 경우, 다음과 같이 에러를 래핑하여 반환할 수 있습니다:

```go
// HealthCheck 함수는 헬스 체크 요청을 처리합니다.
func (r *HealthController) HealthCheck(f *fiber.Ctx) error {
    if err := r.HealthChecker.HealthCheck(); err != nil {
        f.Status(fiber.StatusInternalServerError)
        log.Error("health check failed", err)
        return fmt.Errorf("health check failed: %w", err)
    }

    if err := f.SendStatus(fiber.StatusOK); err != nil {
        return fmt.Errorf("failed to send status: %w", err)
    }

    return nil
}
```

이렇게 수정하면, 에러가 발생했을 때 호출자는 `errors.Is` 또는 `errors.As`를 사용하여 원래의 에러 타입을 확인하고, 필요한 조치를 취할 수 있습니다. 이러한 방식으로 에러를 처리하면 `wrapcheck` 도구가 에러를 래핑하지 않았다는 경고를 발생시키지 않을 것입니다.
